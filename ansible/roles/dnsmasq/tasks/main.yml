---
- name: Install Dnsmasq package
  become: yes
  apt:
    name: dnsmasq
    state: present

- name: Install resolvconf package
  become: yes
  apt:
    name: resolvconf
    state: present

- name: Enable dnsmasq service
  become: yes
  service:
    name: dnsmasq
    enabled: true

- name: Remove localhost-only binding from dnsmasq
  become: yes
  lineinfile:
    dest: /etc/dnsmasq.conf
    state: absent
    line: 'listen-address=127.0.0.1'
  notify: restart dnsmasq

- name: Gather network facts
  become: yes
  setup:
    gather_subset:
      - '!all'
      - network

- name: Check if resolv.conf exists
  become: yes
  stat:
    path: /etc/resolv.conf
    follow: no
  register: resolvconf

- name: Add localhost to resolv.conf
  become: yes
  lineinfile:
    dest: /etc/resolv.conf
    state: present
    line: 'nameserver 127.0.0.1'
    insertbefore: BOF
  when: resolvconf.stat.exists and not resolvconf.stat.islnk

- name: Set dnsmasq user to root
  become: yes
  lineinfile: 
    dest: /etc/dnsmasq.conf 
    state: present 
    line: 'user=root'

- name: Stop and disable systemd-resolved
  become: yes
  systemd:
    name: systemd-resolved
    state: stopped
    enabled: no
    masked: yes

- name: Ensure systemd-resolve directory exists for Docker compatibility
  become: yes
  file:
    path: /run/systemd/resolve
    state: directory
    mode: '0755'

- name: Point systemd-resolve resolv.conf to dnsmasq for Docker compatibility
  become: yes
  copy:
    content: "nameserver 127.0.0.1\n"
    dest: /run/systemd/resolve/resolv.conf
    mode: '0644'
  notify: restart docker

- name: Remove resolv.conf symlink
  become: yes
  file:
    path: /etc/resolv.conf
    state: absent
  when: resolvconf.stat.islnk is defined and resolvconf.stat.islnk

- name: Create resolv.conf with dnsmasq
  become: yes
  copy:
    content: "nameserver 127.0.0.1\n"
    dest: /etc/resolv.conf
    owner: root
    group: root
    mode: '0644'
  when: resolvconf.stat.islnk is defined and resolvconf.stat.islnk

- name: Ensure resolv.conf exists with dnsmasq
  become: yes
  copy:
    content: "nameserver 127.0.0.1\n"
    dest: /etc/resolv.conf
    owner: root
    group: root
    mode: '0644'
    force: no

- name: Create Dnsmasq configuration
  become: yes
  template:
    src: dnsmasq-10-consul.j2
    dest: /etc/dnsmasq.d/10-consul
    owner: root
    group: root
    mode: 0644
  vars:
    network_interfaces: "{{ ansible_interfaces }}"
  notify: restart dnsmasq
  
- name: Create systemd override directory for dnsmasq
  become: yes
  file:
    path: /etc/systemd/system/dnsmasq.service.d
    state: directory
    mode: 0755

# - name: Add override for dnsmasq service
#   become: yes
#   copy:
#     dest: /etc/systemd/system/dnsmasq.service.d/override.conf
#     content: |
#       [Unit]
#       After=docker.service

- name: Remove override for dnsmasq service
  become: yes
  file:
    path: /etc/systemd/system/dnsmasq.service.d/override.conf
    state: absent
    
- name: Launch dnsmasq
  become: yes
  service:
    name: dnsmasq
    state: started

- name: Flush handlers to restart dnsmasq before other roles
  meta: flush_handlers
